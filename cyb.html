<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Cybertech Predictor â€” History & Charts</title>
<style>
  /* Cybertech Dark Theme Variables */
  :root{
    --bg:#1a1f2e;
    --card: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02);
    --accent1: #00e6ff; /* Cyan */
    --accent2: #9b5cff; /* Purple */
    --muted: #9fb3c8;
    --win:#16a34a;
    --loss:#ef4444; /* Red for loss/highlight */
    --violet:#a855f7;
    --gold:#f6c84c;
    --chip-bg: rgba(255,255,255,0.03);
    --neon-shadow: 0 8px 30px rgba(0, 230, 255, 0.06), 0 0 12px rgba(155,92,255,0.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg, var(--bg), #0f1625);
    color:#e6f2fb; /* Light text color */
    padding:12px;
    -webkit-font-smoothing:antialiased;
    -moz-osx-osx-font-smoothing:grayscale;
    overflow: hidden; /* Prevent main page scroll */
  }
  .wrap{
    max-width:400px;
    margin:0 auto;
    display:flex;
    flex-direction:column;
    gap:8px;
    height: calc(100vh - 24px); /* Adjust height to fit screen, considering padding */
    overflow-y: auto; /* Allow internal scrolling if content exceeds viewport height */
    overflow-x: hidden; /* Prevent horizontal scroll within wrap */
  }
  header{
    display:flex;align-items:center;gap:8px; margin-bottom:8px;
  }
  .logo{
    width:64px;height:64px;border-radius:12px;
    background:linear-gradient(135deg,var(--accent1),var(--accent2));
    display:flex;align-items:center;justify-content:center;font-weight:800;color:#001;
    font-size:20px;box-shadow:0 10px 30px rgba(0,0,0,0.6);
  }
  h1{margin:0;font-size:18px;letter-spacing:0.2px}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:12px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.03);
    box-shadow: var(--neon-shadow);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .section{margin-bottom:8px}
  label.small{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  input[type="number"], select{
    width:100%;padding:8px;
    border-radius:6px;
    border:1px solid rgba(255,255,255,0.04);
    background: rgba(0,0,0,0.18); color: #e6f2fb; font-size:12px;
    outline:none;
  }
  .modes{display:flex;gap:6px; margin-top:6px}
  .modeBtn{
    padding:6px 10px;
    border-radius:6px;
    border:none;font-weight:700;cursor:pointer;
    background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03);
    transition:all .18s ease;
    font-size:12px;
  }
  .modeBtn.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#001; box-shadow:0 6px 18px rgba(0,230,255,0.06)}
  .row{display:flex;gap:6px; align-items:center}
  .btn{padding:8px 10px;
    border-radius:6px;
    border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#001;font-weight:700;
    transition:transform .12s, box-shadow .18s; font-size:12px}
  .btn:hover{box-shadow:0 6px 18px rgba(0,230,255,0.12)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .btn.warn{background:var(--loss);color:#fff}
  .btn.ok{background:var(--win);color:#001}
  .result-card{display:flex;gap:8px;
    align-items:center;padding:10px;
    border-radius:10px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.02)}
  .res-num{font-size:24px; font-weight:900;letter-spacing:1px; color:#e6f2fb;}
  .res-meta{color:var(--muted);font-weight:700; font-size:11px}
  
  /* Combined display for prediction text */
  #displaySub {
    white-space: nowrap; /* Keep content on one line */
    overflow: hidden; /* Hide overflow */
    text-overflow: ellipsis; /* Add ellipsis for overflowed text */
    margin-top:0;
    font-size: 12px;
    color: var(--muted);
  }
  /* Period Number input field cutoff fix */
  .panel .section .row > div:first-child { /* This is the div containing periodInput */
    flex: 1.5; /* Give it more space */
    min-width: 150px; /* Ensure it has a minimum width */
  }
  .panel .section .row > div:nth-child(2) { /* AI Strength select */
      flex: 1;
      min-width: 100px; /* Adjust as needed */
  }
  .panel .section .row > div:last-child { /* Predict button container */
      width: 90px;
      flex-shrink: 0; /* Prevent it from shrinking */
  }
  
  #statsRow{
    display:flex;gap:4px; margin-top:8px; flex-wrap: nowrap;
    justify-content: space-between;
  }
  .stat-card{
    flex:1;padding:8px;
    border-radius:6px;
    background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03);text-align:center;
    box-shadow:0 8px 30px rgba(0,0,0,0.6);
    transition:transform .18s ease;
  }
  .stat-card:hover{transform:translateY(-4px)}
  .stat-title{font-size:10px; color:var(--muted);margin-bottom:4px}
  .stat-value{font-size:12px; font-weight:900; color:#e6f2fb;}
  .side{
    display:flex;
    flex-direction:column;
    gap:8px;
    flex-grow: 1; /* Allow side content to take remaining space */
    min-height: 0; /* Important for flex items */
  }
  .side-tabs {
    display: flex;
    gap: 6px;
    margin-bottom: 6px;
    justify-content: center;
  }
  .tab-btn {
    padding: 6px 10px;
    border-radius: 6px 6px 0 0;
    border: none;
    cursor: pointer;
    background: rgba(255,255,255,0.02);
    color: var(--muted);
    font-weight: 700;
    font-size: 12px;
    transition: all .18s ease;
  }
  .tab-btn.active {
    background: linear-gradient(90deg, var(--gold), var(--gold)); /* Gold for active tab */
    color: #001;
    box-shadow: 0 6px 18px rgba(246,200,76,0.06);
  }
  .side-content {
    display: none;
    background: var(--card);
    padding: 10px;
    border-radius: 10px;
    border:1px solid rgba(255,255,255,0.03); /* dark theme border */
    box-shadow: var(--neon-shadow); /* dark theme shadow */
    flex-grow: 1; /* Allow content to fill available height */
    min-height: 0; /* Important for flex items */
  }
  .side-content.active {
    display: block;
  }
  .history-card-content, .game-history-content {
    display: flex;
    flex-direction: column;
    gap: 6px;
    height: 100%; /* Fill parent side-content height */
  }
  .game-history-content > div:last-child,
  .history-card-content > div:last-child {
    flex-grow: 1; /* Allow history lists to take remaining vertical space */
    overflow-y: auto; /* Internal scroll for history lists */
    overflow-x: hidden; /* Prevent horizontal scroll for history lists */
    min-height: 0; /* Important for flex-grow with overflow */
  }

  /* Game History Table header and alignment */
  #gameHistoryTable {
    width:100%;
    border-collapse:collapse;
    font-size:12px;
    color:#dfeefc;
    table-layout: fixed; /* Ensures columns respect widths */
  }
  #gameHistoryTable thead {
    background: rgba(255,255,255,0.05); /* Slightly darker header background */
  }
  #gameHistoryTable th, #gameHistoryTable td {
    padding:8px 6px; /* Increased padding */
    border-bottom:1px dashed rgba(255,255,255,0.03);
    vertical-align:middle;
    white-space: nowrap; /* Prevent content wrapping in cells */
    overflow: hidden; /* Hide overflow content if any */
    text-overflow: ellipsis; /* Add ellipsis for overflowed text */
  }
  #gameHistoryTable th {
    color:var(--muted);
    font-weight:700;
    font-size:10px;
    text-align: center; /* Default center for headers */
  }
  /* Column widths for Game History for better justification */
  #gameHistoryTable th:nth-child(1), #gameHistoryTable td:nth-child(1) { width: 30%; text-align: left; padding-left: 10px;} /* Period */
  #gameHistoryTable th:nth-child(2), #gameHistoryTable td:nth-child(2) { width: 15%; text-align: center; } /* Number */
  #gameHistoryTable th:nth-child(3), #gameHistoryTable td:nth-child(3) { width: 15%; text-align: center; } /* Big Small */
  #gameHistoryTable th:nth-child(4), #gameHistoryTable td:nth-child(4) { width: 20%; text-align: center; } /* Color */
  #gameHistoryTable th:nth-child(5), #gameHistoryTable td:nth-child(5) { width: 20%; text-align: right; padding-right: 10px;} /* Status */
  #gameHistoryTable td small{display:block;color:var(--muted);font-weight:600;margin-top:2px}

  /* Color dot for Game History table */
  .color-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 4px;
    vertical-align: middle;
  }
  .color-dot-red { background: var(--loss); }
  .color-dot-green { background: var(--win); }
  .color-dot-violet { background: var(--violet); }
  .color-dot-default { background: var(--muted); } /* Fallback */

  /* --- Chart Specific Styles (Adapted from BHT CLUB image, to dark theme) --- */
  .chart-content {
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.05)); /* Dark theme background */
    border-radius: 10px;
    padding: 10px;
    position: relative;
    height: 100%; /* Fill parent side-content height */
    display: flex;
    flex-direction: column;
  }
  .chart-header-row { /* Period | Number header like BHT CLUB image */
    display: flex;
    justify-content: space-between;
    padding: 8px 10px;
    background: var(--chip-bg); /* Darker background for header row */
    color: var(--gold); /* Gold text for header */
    font-weight: 700;
    border-radius: 8px 8px 0 0;
    font-size: 14px;
    margin: -10px -10px 0 -10px; /* Adjust to cover full width of chart-content */
    border-bottom: 1px solid rgba(255,255,255,0.03);
    flex-shrink: 0; /* Prevent shrinking */
  }
  .chart-header-row div {
      flex: 1;
      text-align: center;
  }
  .chart-header-row div:first-child { text-align: left; padding-left: 10px; }
  .chart-header-row div:last-child { text-align: right; padding-right: 10px; }

  .stats-section-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--muted); /* Muted color for title */
    margin-top: 10px;
    margin-bottom: 5px;
    padding: 0 5px;
    flex-shrink: 0;
  }
  .stats-section-title span {
    color: var(--muted);
    font-weight: normal;
    font-size: 12px;
    margin-left: 5px;
  }

  .stats-grid {
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); /* Dark theme background */
    border-radius: 8px;
    padding: 4px;
    border: 1px solid rgba(255,255,255,0.02);
    display: flex;
    flex-direction: column; /* Stack rows vertically */
    gap: 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    flex-shrink: 0; /* Prevent shrinking */
  }
  .stats-grid .stats-row {
    display: flex;
    align-items: center;
    padding: 4px 5px;
    border-bottom: 1px solid rgba(255,255,255,0.02); /* Dark theme separator */
    flex-wrap: nowrap;
  }
  .stats-grid .stats-row:last-child {
    border-bottom: none;
  }
  .stats-row-label {
    min-width: 100px; /* Reduced min-width to fit better */
    font-size: 11px; /* Smaller font size */
    font-weight: 600;
    color: var(--muted); /* Dark theme label color */
    flex-shrink: 0;
    white-space: nowrap;
    padding: 0;
    margin-right: 5px; /* Reduced margin */
  }
  .stats-row-values {
    display: flex;
    gap: 3px; /* Reduced gap */
    overflow-x: hidden; /* Hide overflow, try to fit */
    flex-grow: 1;
    min-width: 0;
    white-space: nowrap;
    padding: 0;
    justify-content: space-between; /* Distribute cells evenly */
  }
  .stats-row-values .cell {
    min-width: 18px; /* Smaller cells */
    height: 18px;
    border-radius: 50%; /* Circular cells */
    background: transparent;
    border: 1px solid rgba(255,255,255,0.1); /* Light border for contrast */
    color: #dfeefc; /* Light text for numbers */
    font-weight: 500;
    font-size: 9px; /* Smaller font size */
    flex-shrink: 0;
    flex-basis: auto; /* Allow auto-sizing within flex container */
    padding: 0 1px; /* Minimal padding */
  }
  /* Specific styling for Winning Numbers in stats grid */
  #winningChips .cell {
    border: 1px solid var(--loss); /* Red border for winning numbers */
    color: var(--loss); /* Red text */
    font-weight: 700;
  }

  /* Chart History Lines styling */
  #chartHistoryLinesContainer {
    flex-grow: 1; /* Allow to take available vertical space */
    overflow-y: auto; /* Internal scroll for chart history */
    overflow-x: hidden; /* No horizontal scroll */
    position: relative;
    margin-top: 8px;
    border-radius: 8px;
    background: rgba(255,255,255,0.01); /* Dark theme background */
    padding: 0;
    min-height: 0; /* Important for flex-grow with overflow */
  }
  .chart-history-line {
    display: flex;
    align-items: center;
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.02); /* Dark theme separator */
    background: rgba(255,255,255,0.01); /* Dark theme background for lines */
    white-space: nowrap;
  }
  .chart-history-line:last-child {
    border-bottom: none;
  }
  .chart-period-label {
    min-width: 110px;
    font-weight: 600;
    font-size: 12px;
    color: #dfeefc; /* Light text for period number */
    flex-shrink: 0;
    padding: 0;
  }
  .chart-chips-row {
    display: flex;
    gap: 3px; /* Reduced gap */
    overflow-x: hidden; /* Hide overflow */
    flex-grow: 1;
    min-width: 0;
    white-space: nowrap;
    justify-content: space-between; /* Space out chips for 0-9 */
    align-items: center;
    padding: 0;
    position: relative;
  }
  .chart-chips-row .chip {
    min-width: 16px; /* Smaller chips */
    height: 16px;
    border-radius: 50%;
    background: transparent;
    border: 1px solid rgba(255,255,255,0.1); /* Light border */
    color: var(--muted); /* Muted text for non-highlighted */
    font-weight: 500;
    font-size: 8px; /* Smaller font size */
    flex-shrink: 0;
    flex-basis: auto;
    padding: 0 1px;
  }
  .chart-chips-row .chip.highlighted {
    background: var(--loss); /* Solid red fill for winning number */
    border: 1px solid var(--loss);
    color: white; /* White text on red background */
    font-weight: 700;
    box-shadow: 0 2px 5px rgba(239,68,68,0.3); /* Subtle shadow */
    transform: scale(1.05);
  }

  /* Big/Small badges - kept colors from BHT image */
  .chart-sb-badge {
    min-width: 24px;
    height: 24px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 11px;
    background: #6c757d; /* Default grey */
    color: white;
    flex-shrink: 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .chart-sb-badge.badge-b { /* Yellow B as in BHT image */
    background: #ffc107;
    color: #212529;
  }
  .chart-sb-badge.badge-s { /* Blue S as in BHT image */
    background: #007bff;
    color: white;
  }

  .chart-line-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
  }

  /* Paginaton controls (for chart) */
  .chart-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    padding: 8px 0;
    border-top: 1px solid rgba(255,255,255,0.02); /* Dark theme separator */
    flex-shrink: 0;
  }
  .chart-pagination button {
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.03);
    color: var(--muted);
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
  }
  .chart-pagination button:hover {
    background: rgba(255,255,255,0.05);
  }
  .chart-pagination span {
    font-weight: 600;
    color: #e6f2fb; /* Light text for page number */
  }

  /* --- My History Section Styling --- */
  #my-history .chart-header-row { /* Reusing chart-header-row for consistent look */
    margin-bottom: 0;
    border-radius: 8px 8px 0 0;
    flex-shrink: 0;
  }
  #historyLinesContainer {
    flex-grow: 1; /* Allow to take available vertical space */
    overflow-y: auto; /* Internal scroll for history list */
    overflow-x: hidden; /* Prevent horizontal scroll */
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
    background: rgba(255,255,255,0.01);
    border-left: 1px solid rgba(255,255,255,0.03);
    border-right: 1px solid rgba(255,255,255,0.03);
    border-bottom: 1px solid rgba(255,255,255,0.03);
    min-height: 0;
  }
  .history-line {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 8px 10px; /* Increased padding for better spacing */
    border-bottom: 1px dashed rgba(255,255,255,0.02);
    background: rgba(255,255,255,0.01);
    border-radius: 0;
    margin: 0;
    white-space: nowrap;
  }
  .history-line:last-child {
      border-bottom: none;
  }

  .history-period {
    min-width: 100px; /* Period number width adjusted */
    font-weight: 900;
    font-size: 11px;
    padding: 0; /* Remove padding */
    flex-shrink: 0;
    color: #dfeefc;
    text-align: left;
  }
  .history-chips-row {
    display: flex;
    gap: 2px;
    overflow-x: hidden; /* Hide overflow */
    flex-grow: 1;
    min-width: 0;
    white-space: nowrap;
    justify-content: space-between; /* Space out chips for 0-9 */
    align-items: center;
    padding: 0 4px; /* Small padding */
  }
  .history-chips-row .chip {
    min-width: 16px; /* Smaller chips for 0-9 to fit */
    height: 16px;
    border-radius:6px;
    background:var(--chip-bg);display:inline-flex;align-items:center;justify-content:center;
    border:1px solid rgba(255,255,255,0.04);font-weight:800;color:var(--muted);flex:0 0 auto;
    font-size:8px; /* Smaller font size */
    transition: all 0.2s ease;
    flex-basis: auto; /* Allow auto-sizing */
    padding: 0 1px;
  }
  .history-chips-row .chip.highlighted {
    background: linear-gradient(90deg, var(--loss), var(--loss));
    color: #fff;
    border: none;
    box-shadow: 0 4px 12px rgba(239,68,68,0.3);
  }
  .history-right {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
    min-width: 40px; /* Adjusted min-width for result icons */
    justify-content: center; /* Center result icons */
    padding-right: 10px; /* Padding on right */
  }
  /* Result Icons for My History */
  .result-icon {
    font-size: 18px; /* Larger icon size */
    font-weight: 900;
    color: var(--win); /* Green for win */
    text-shadow: 0 0 4px rgba(22,163,74,0.4);
  }
  .result-icon.loss {
    color: var(--loss); /* Red for loss */
    text-shadow: 0 0 4px rgba(239,68,68,0.4);
  }
  .result-icon.pending {
      color: var(--muted);
  }


  .status-pend{color:var(--muted);font-weight:700}
  .status-win{color:var(--win);font-weight:800}
  .status-lost{color:var(--loss);font-weight:800}
  
  .color-green{color:var(--win);font-weight:900}
  .color-red{color:var(--loss);font-weight:900}
  .color-violet{color:var(--violet);font-weight:900}
  .num-green{color:var(--win);font-weight:900}
  .num-red{color:var(--loss);font-weight:900}
  .num-split-0, .num-split-5{font-weight:900; background-clip:text; -webkit-background-clip:text; color:transparent}
  .num-split-0{background-image: linear-gradient(90deg, var(--loss) 50%, var(--violet) 50%)}
  .num-split-5{background-image: linear-gradient(90deg, var(--win) 50%, var(--violet) 50%)}
  .icon-btn{padding:4px 6px; border-radius:4px; border:none;cursor:pointer;font-weight:800;margin:0 2px; font-size:10px}
  .icon-win{background:var(--win);color:#001; transition: transform 0.2s}
  .icon-win:hover{transform: scale(1.1)}
  .icon-loss{background:var(--loss);color:#fff; transition: transform 0.2s}
  .icon-loss:hover{transform: scale(1.1)}
  .glow-anim {
    animation: newGlow 900ms ease forwards;
    box-shadow: 0 10px 30px rgba(0,230,255,0.18), 0 0 24px rgba(155,92,255,0.12);
    transform: translateY(-4px);
  }
  @keyframes newGlow {
    0% { opacity: 0; transform: translateY(8px) scale(0.96); filter: blur(6px); }
    40% { opacity:1; transform: translateY(0px) scale(1.02); filter: blur(0px); }
    100% { opacity:1; transform: translateY(0px) scale(1); filter: blur(0px); }
  }

  /* --- Mobile Specific Adjustments --- */
  @media (max-width:640px){
    body{padding:8px}
    .wrap{height: calc(100vh - 16px);} /* Adjust height for mobile padding */
    header { padding: 8px; }
    .logo { width: 48px; height: 48px; font-size: 16px; }
    h1 { font-size: 16px; }
    p.lead { font-size: 11px; }

    .res-num{font-size:20px}
    .res-meta{font-size:10px}
    /* Prediction text on small screens */
    #displaySub {
      white-space: normal; /* Allow wrapping */
      font-size: 11px;
    }

    /* Period Number input field cutoff fix for mobile */
    .panel .section .row > div:first-child {
        flex: 1.2; /* Give it more space relative to others on mobile */
        min-width: 120px; /* Ensure a minimum width */
    }
    .panel .section .row > div:nth-child(2) {
        flex: 0.8; /* Adjust AI Strength to be smaller */
        min-width: 80px; /* Adjust as needed */
    }
    .panel .section .row > div:last-child {
        width: 80px; /* Smaller button on mobile */
    }


    #statsRow {
      flex-direction: row;
      flex-wrap: nowrap;
      overflow-x: auto;
      justify-content: flex-start;
    }
    #statsRow .stat-card {
      flex-shrink: 0;
      min-width: 60px;
      padding: 6px;
    }
    .stat-title{font-size:9px;}
    .stat-value{font-size:11px;}

    /* Game History Table */
    #gameHistoryTable { display: block; overflow-x: auto; white-space: nowrap; }
    #gameHistoryTable th, #gameHistoryTable td {
      width: auto !important; /* Override fixed widths */
      min-width: 50px; /* Ensure minimum width */
      padding: 4px;
      font-size: 10px;
    }
    #gameHistoryTable th:nth-child(1), #gameHistoryTable td:nth-child(1) { text-align: left; padding-left: 5px;}
    #gameHistoryTable th:nth-child(5), #gameHistoryTable td:nth-child(5) { text-align: right; padding-right: 5px;}


    /* Chart sections */
    .chart-header-row {
      font-size: 12px;
      padding: 6px 8px;
    }

    /* Chart Stats Grid */
    .stats-grid {
      flex-direction: column;
      width: 100%;
      padding: 4px;
    }
    .stats-grid .stats-row {
      flex-direction: row;
      flex-wrap: nowrap;
      align-items: center;
      flex: 1 1 100%;
    }
    .stats-row-label {
      min-width: 80px; /* Even smaller for mobile */
      font-size: 10px;
      margin-right: 3px;
    }
    .stats-row-values {
      overflow-x: hidden;
      flex-grow: 1;
      min-width: 0;
      white-space: nowrap;
      gap: 2px; /* Smaller gap for mobile */
    }
    .stats-row-values .cell,
    .stats-row-values .chip {
      min-width: 16px; /* Smaller cells/chips */
      height: 16px;
      font-size: 8px; /* Smaller font size */
      padding: 0;
    }

    /* Chart history lines */
    .chart-history-line {
      flex-direction: row;
      align-items: center;
      gap: 3px;
      white-space: nowrap;
      overflow-x: hidden;
      justify-content: flex-start;
      padding: 6px 8px;
    }
    .chart-period-label {
      min-width: 90px;
      font-size: 10px;
    }
    .chart-chips-row {
      gap: 2px; /* Smaller gap */
      justify-content: space-between; /* To fit 0-9 */
    }
    .chart-chips-row .chip {
      min-width: 16px;
      height: 16px;
      font-size: 8px;
    }
    .chart-sb-badge {
      min-width: 20px;
      height: 20px;
      font-size: 10px;
    }

    /* My History Lines */
    .history-line {
      flex-direction: row;
      align-items: center;
      gap: 3px;
      white-space: nowrap;
      overflow-x: hidden;
      justify-content: flex-start;
      padding: 6px 8px; /* Adjusted padding */
    }
    .history-period { min-width: 80px; font-size: 10px; text-align: left;}
    .history-chips-row { gap: 2px; justify-content: space-between; padding: 0 2px;} /* Space between chips */
    .history-chips-row .chip { min-width: 16px; height: 16px; font-size: 8px; } /* Even smaller chips */
    .history-right { gap: 2px; min-width: 30px; padding-right: 5px; justify-content: center;} /* Center result icons */
    .result-icon { font-size: 16px; } /* Smaller icons on mobile */
    .icon-btn {padding: 3px 5px; font-size: 9px;}
  }
  ::-webkit-scrollbar { width: 6px; height:6px; }
  ::-webkit-scrollbar-track { background: rgba(255,255,255,0.01); border-radius: 6px; }
  ::-webkit-scrollbar-thumb { background: linear-gradient(180deg,var(--accent1),var(--accent2)); border-radius: 6px; border: 2px solid rgba(0,0,0,0.14); }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">CT</div>
      <div>
        <h1>Cybertech Predictor â€” History & Charts</h1>
        <p class="lead">S+N & S+C â€¢ Pattern-aware AI â€¢ Auto-next period â€¢ Local storage</p>
      </div>
    </header>
    <div class="panel">
      <div class="section">
        <div class="row" style="align-items: center;">
          <div style="flex: 1;">
            <label class="small">Period Number</label>
            <input id="periodInput" type="number" placeholder="e.g. 202509151539" style="width: 100%;" />
          </div>
          <div style="flex: 1; margin-left: 6px;">
            <label class="small">AI Strength</label>
            <select id="aiStrength" style="width: 100%;">
              <option value="0.0">0 â€” no bias</option>
              <option value="0.25">0.25 â€” light</option>
              <option value="0.5" selected>0.5 â€” balanced</option>
              <option value="0.75">0.75 â€” strong</option>
              <option value="0.95">0.95 â€” very strong</option>
            </select>
          </div>
          <div style="width: 90px; margin-left: 6px;">
            <label class="small">&nbsp;</label>
            <button id="predictBtn" class="btn" style="width: 100%; padding: 8px;">Predict</button>
          </div>
        </div>
        <div class="modes">
          <button id="btnSN" class="modeBtn active" data-mode="size-number">S+N</button>
          <button id="btnSC" class="modeBtn" data-mode="size-color">S+C</button>
        </div>
        <div class="small-note">Tip: Mark Win/Loss to auto-generate next prediction.</div>
      </div>
      <div class="section">
        <div class="result-card" aria-live="polite">
          <div>
            <div class="res-num" id="displayNumber">â€”</div>
            <div class="res-meta" id="displaySize">â€”</div>
          </div>
          <div style="flex:1">
            <div id="displayTitle">No prediction yet</div>
            <div id="displaySub" class="muted">Enter period and click Predict.</div>
            <div id="displayColor" style="margin-top:4px"></div>
            <!-- aiNotes is now combined into displaySub, so it's hidden -->
            <div id="aiNotes" style="display:none;"></div> 
          </div>
        </div>
        <div style="display:flex;gap:4px; margin-top:6px; flex-wrap:wrap">
          <button id="markWin" class="btn ok">Mark Win</button>
          <button id="markLoss" class="btn secondary">Mark Loss</button>
          <button id="clearAll" class="btn secondary">Clear All</button>
          <button id="exportCSV" class="btn secondary">Export CSV</button>
        </div>
      </div>
      <div id="statsRow" style="display: none;">
        <div class="stat-card" id="statWinCard"><div class="stat-title">Win</div><div class="stat-value" id="statWin">0</div></div>
        <div class="stat-card" id="statLossCard"><div class="stat-title">Loss</div><div class="stat-value" id="statLoss">0</div></div>
        <div class="stat-card" id="statAccCard"><div class="stat-title">Accuracy</div><div class="stat-value" id="statAcc">0%</div></div>
        <div class="stat-card" id="statRevCard"><div class="stat-title">Reverse</div><div class="stat-value" id="statRev">0%</div></div>
      </div>
    </div>
    <div class="side">
      <div class="side-tabs">
        <button class="tab-btn" data-tab="game-history">Game history</button>
        <button class="tab-btn active" data-tab="chart">Chart</button>
        <button class="tab-btn" data-tab="my-history">My history</button>
      </div>
      <div id="game-history" class="side-content">
        <div class="game-history-content">
          <h4 style="margin: 0 0 6px 0; color: #e6f2fb;">Game History</h4>
          <div style="font-size:12px;color:var(--muted);margin-bottom:4px">Confirmed wins & losses.</div>
          <div style="overflow-x:auto;">
            <table id="gameHistoryTable">
              <thead><tr><th>Period</th><th>Number</th><th>Big Small</th><th>Color</th><th>Status</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="chart" class="side-content active">
        <div class="chart-content">
          <div class="chart-header-row">
            <div style="text-align: left;">Period</div>
            <div style="text-align: right;">Number</div>
          </div>
          <div class="stats-section-title">Statistic <span>(last 100 Periods)</span></div>
          <div class="stats-grid">
            <div class="stats-row">
              <div class="stats-row-label">Winning Numbers</div>
              <div class="stats-row-values" id="winningChips"></div>
            </div>
            <div class="stats-row">
              <div class="stats-row-label">Missing</div>
              <div class="stats-row-values" id="missingRow"></div>
            </div>
            <div class="stats-row">
              <div class="stats-row-label">Avg missing</div>
              <div class="stats-row-values" id="avgMissingRow"></div>
            </div>
            <div class="stats-row">
              <div class="stats-row-label">Frequency</div>
              <div class="stats-row-values" id="frequencyRow"></div>
            </div>
            <div class="stats-row">
              <div class="stats-row-label">Max consecutive</div>
              <div class="stats-row-values" id="maxConsRow"></div>
            </div>
          </div>
          <div id="chartHistoryLinesContainer" style="margin-top: 8px; border-radius: 8px; background: rgba(255,255,255,0.01); padding: 0;">
            <!-- Chart history lines will be appended here -->
          </div>
          <div class="chart-pagination">
            <button>&lt;</button>
            <span>1/50</span>
            <button>&gt;</button>
          </div>
        </div>
      </div>
      <div id="my-history" class="side-content">
        <div class="history-card-content">
          <div class="chart-header-row">
              <div style="text-align: left;">Period</div>
              <div>Numbers (0-9)</div>
              <div style="text-align: right;">Result</div>
          </div>
          <div id="historyLinesContainer">
            <!-- History lines will be appended here -->
          </div>
        </div>
      </div>
    </div>
    <footer>Built-in local storage â€¢ Auto-next period â€¢ Improved pattern analysis</footer>
  </div>
<script>
/* State & storage */
const STORAGE_KEY = 'cybertech_full_history_v1';
let state = {
  history: [], // newest-first: {period, number, size, color, mode, status, notes, ts}
  mode: 'size-number'
};
const maxHistoryShown = 500;
const STATS_RANGE = 100; // last N periods used for stats
/* DOM refs */
const periodInput = document.getElementById('periodInput');
const predictBtn = document.getElementById('predictBtn');
const displayNumber = document.getElementById('displayNumber');
const displaySize = document.getElementById('displaySize');
const displayTitle = document.getElementById('displayTitle');
const displaySub = document.getElementById('displaySub');
const displayColor = document.getElementById('displayColor');
const aiNotes = document.getElementById('aiNotes');
const historyLinesContainer = document.getElementById('historyLinesContainer');
const gameTableBody = document.querySelector('#gameHistoryTable tbody');
const btnSN = document.getElementById('btnSN');
const btnSC = document.getElementById('btnSC');
const markWin = document.getElementById('markWin');
const markLoss = document.getElementById('markLoss');
const clearAll = document.getElementById('clearAll');
const exportCSV = document.getElementById('exportCSV');
const aiStrengthSel = document.getElementById('aiStrength');
const statWin = document.getElementById('statWin');
const statLoss = document.getElementById('statLoss');
const statAcc = document.getElementById('statAcc');
const statRev = document.getElementById('statRev');
const winningChips = document.getElementById('winningChips');
const missingRow = document.getElementById('missingRow');
const avgMissingRow = document.getElementById('avgMissingRow');
const frequencyRow = document.getElementById('frequencyRow');
const maxConsRow = document.getElementById('maxConsRow');
const chartHistoryLinesContainer = document.getElementById('chartHistoryLinesContainer');
const statsRow = document.getElementById('statsRow');
const statWinCard = document.getElementById('statWinCard');
const statLossCard = document.getElementById('statLossCard');
const statAccCard = document.getElementById('statAccCard');
const statRevCard = document.getElementById('statRevCard');
/* Helpers */
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.history.slice(0,maxHistoryShown))); }
function loadState(){ const raw = localStorage.getItem(STORAGE_KEY); state.history = raw ? JSON.parse(raw) : []; }
function formatDate(ts){ const d = new Date(ts); return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }

// Helper to increment very large period numbers using BigInt
function incrementPeriodString(periodStr) {
    try {
        if (!periodStr || !/^\d+$/.test(periodStr)) {
            console.warn("Invalid period string for increment:", periodStr);
            return String(Date.now()); // Fallback
        }
        let num = BigInt(periodStr);
        num++;
        return num.toString();
    } catch (e) {
        console.error("Error with BigInt, falling back to Date.now()", e);
        return String(Date.now());
    }
}

function baseNumberFromPeriod(period){
  // For period generation, we use BigInt, but for this calculation, Number() might be sufficient if only last few digits matter for base.
  // Assuming base number calculation doesn't require full precision of the entire large period number string
  const last4 = Number(String(period).slice(-4)); // Take last 4 digits as number
  const squared = (last4 * last4);
  const mixed = (squared + (last4 * 3));
  return Math.floor(mixed % 10);
}
function calcSizeFromNum(n){ return (n >= 5) ? 'Big' : 'Small'; }
function calcColorFromNum(n){
  if ([0,2,4,6,8].includes(n)) return 'Red';
  if ([1,3,5,7,9].includes(n)) return 'Green';
  return 'Violet';
}
function analyzePatterns(){
  const recent = state.history.slice(0,8);
  if (!recent.length) return { sizeOppositeBias: { Big: 0.5, Small: 0.5 }, colorBias: { Red: 1/3, Green: 1/3, Violet: 1/3 }, notes: 'No history' };
  const sizeCount = { Big:0, Small:0 };
  const colorCount = { Red:0, Green:0, Violet:0 };
  for (const r of recent){ if (r.size) sizeCount[r.size] += 1; if (r.color) colorCount[r.color] += 1; }
  const total = recent.length;
  const sizeBias = { Big: sizeCount.Big/total, Small: sizeCount.Small/total };
  const preferOpposite = { Big: 1 - sizeBias.Big, Small: 1 - sizeBias.Small };
  const totalColor = Math.max(1, Object.values(colorCount).reduce((a,b)=>a+b,0));
  let colorBias = {};
  Object.keys(colorCount).forEach(k => colorBias[k] = ((totalColor - colorCount[k]) + 0.2) / (totalColor + 0.6));
  const sumCB = Object.values(colorBias).reduce((a,b)=>a+b,0);
  Object.keys(colorBias).forEach(k => colorBias[k] /= sumCB);
  const mostSize = sizeCount.Big > sizeCount.Small ? 'Big' : sizeCount.Small > sizeCount.Big ? 'Small' : 'Even';
  const mostColor = Object.keys(colorCount).reduce((a,b)=> colorCount[a]>=colorCount[b]?a:b, 'Red');
  const notes = `Base:${total > 0 ? (state.history[0].number || '-') : '?'} -> ${total > 0 ? (state.history[0].number || '-') : '?'}. Recent ${total} rounds â€” size: ${mostSize}, color: ${mostColor}. Prefers opposite & less frequent.`;
  return { sizeOppositeBias: preferOpposite, colorBias, notes };
}
function biasedNumberPick(base, analysis, strength){
  const weights = new Array(10).fill(1);
  for (let d=0; d<=9; d++){
    const size = calcSizeFromNum(d);
    const color = calcColorFromNum(d);
    weights[d] += (analysis.sizeOppositeBias[size] || 0.5) * 2 * strength;
    const cb = analysis.colorBias || { Red:1/3,Green:1/3,Violet:1/3 };
    weights[d] += ((cb[color] || 0.33) - (1/3)) * 2 * strength;
    const dist = Math.abs(d - base);
    weights[d] += Math.max(0, 3 - dist) * (0.12 * (1 - strength));
    if (weights[d] < 0.01) weights[d] = 0.01;
  }
  const sum = weights.reduce((a,b)=>a+b,0);
  const r = Math.random() * sum;
  let a = 0;
  for (let i=0;i<10;i++){
    a += weights[i];
    if (r <= a) return i;
  }
  return base;
}
function makePrediction(period){
  const mode = state.mode;
  const aiStrength = parseFloat(aiStrengthSel.value || '0.5');
  const base = baseNumberFromPeriod(period);
  const analysis = analyzePatterns();
  const finalNum = biasedNumberPick(base, analysis, aiStrength);
  const size = calcSizeFromNum(finalNum);
  const color = calcColorFromNum(finalNum);
  const notes = `Base:${base} -> ${finalNum}. ${analysis.notes}`;
  const entry = { ts: Date.now(), period, number: finalNum, size, color, mode, status: 'Pending', notes };
  state.history.unshift(entry);
  if (state.history.length > maxHistoryShown) state.history.pop();
  saveState();
  renderAll();
  animateNewResult();
  return entry;
}
function computeNumberStats(range = STATS_RANGE) {
  const arr = state.history.slice(0, range);
  const freq = new Array(10).fill(0);
  const lastSeen = new Array(10).fill(-1);
  const positions = Array.from({length:10}, ()=>[]);
  for (let i=0;i<arr.length;i++){
    const n = arr[i].number;
    freq[n] += 1;
    if (lastSeen[n] === -1) lastSeen[n] = i;
    positions[n].push(i);
  }
  const missing = lastSeen.map(i => (i===-1 ? range : i));
  const avgMissing = positions.map(pos => {
      if (pos.length <= 1) return range;
      let totalDiff = 0;
      for (let i = 0; i < pos.length - 1; i++) {
          totalDiff += (pos[i] - pos[i+1]) - 1;
      }
      return Math.round(totalDiff / (pos.length - 1));
  });
  const maxConsec = new Array(10).fill(0);
  if (arr.length){
    let currentNum = arr[0].number, currentLen=1;
    for (let i=1;i<arr.length;i++){
      if (arr[i].number === currentNum) {
        currentLen++;
      }
      else {
        maxConsec[currentNum] = Math.max(maxConsec[currentNum], currentLen);
        currentNum = arr[i].number;
        currentLen = 1;
      }
    }
    maxConsec[currentNum] = Math.max(maxConsec[currentNum], currentLen);
  }
  return { freq, missing, avgMissing, maxConsec };
}
function numberToHTML(n){
  if (n === 0) return `<span class="num-split-0">${n}</span>`;
  if (n === 5) return `<span class="num-split-5">${n}</span>`;
  if ([1,3,7,9].includes(n)) return `<span class="num-green">${n}</span>`;
  if ([2,4,6,8].includes(n)) return `<span class="num-red">${n}</span>`;
  return `${n}`;
}
function colorTextClass(color){ return color === 'Green' ? 'color-green' : color === 'Red' ? 'color-red' : 'color-violet'; }
function sizeBadgeHTML(size){
  return size === 'Big' ? `<span class="chart-sb-badge badge-b">${size[0]}</span>` : `<span class="chart-sb-badge badge-s">${size[0]}</span>`;
}
function colorDotHTML(color){
  let dotClass = '';
  let textColorClass = '';
  switch(color){
    case 'Red': dotClass = 'color-dot-red'; textColorClass = 'color-red'; break;
    case 'Green': dotClass = 'color-dot-green'; textColorClass = 'color-green'; break;
    case 'Violet': dotClass = 'color-dot-violet'; textColorClass = 'color-violet'; break;
    default: dotClass = 'color-dot-default'; textColorClass = 'color-muted'; break;
  }
  return `<div style="display:flex; align-items:center; justify-content:center; gap:4px;"><span class="color-dot ${dotClass}"></span><span class="${textColorClass}">${color}</span></div>`;
}

function renderAll(){
  renderLastPrediction();
  renderPredictionHistoryLines();
  renderGameTable();
  renderStatsGrid();
  updateStats();
  renderChartHistoryLines();
  updateStatsDisplay();
}
function renderLastPrediction(){
  const last = state.history[0];
  if (!last){
    displayNumber.textContent = 'â€”';
    displaySize.textContent = 'â€”';
    displayTitle.textContent = 'No prediction yet';
    displaySub.innerHTML = '<span class="muted">Enter period and click Predict.</span>';
    aiNotes.textContent = 'â€”'; // Still set for potential debugging, but hidden
    return;
  }
  displayNumber.innerHTML = numberToHTML(last.number);
  displaySize.innerHTML = sizeBadgeHTML(last.size);
  displayTitle.textContent = `Period ${last.period}`;
  
  // Combine prediction status and AI notes into one 'displaySub' element
  displaySub.innerHTML = `${last.mode==='size-number'?'S+N':'S+C'} â€¢ ${last.status} ${last.notes ? `<span class="muted" style="font-size:10px; margin-left:8px;">${last.notes}</span>` : ''}`;
  
  if (last.mode==='size-color') displayColor.innerHTML = `<div style="margin-top:4px"><span style="padding:4px 8px;border-radius:999px;font-weight:800;background:#0b0b0b" class="${colorTextClass(last.color)}">${last.color}</span></div>`;
  else displayColor.innerHTML = '';
  // aiNotes element is now effectively unused visually
}
function renderPredictionHistoryLines(){
  historyLinesContainer.innerHTML = '';
  const show = Math.min(state.history.length, 500); // Allow more items if container expands
  for (let idx=0; idx<show; idx++){
    const h = state.history[idx];
    const line = document.createElement('div');
    line.className = 'history-line';
    
    let resultContent;
    if (h.status === 'Pending') {
        resultContent = `<div style="display:flex;gap:4px">
                            <button class="icon-btn icon-win" title="Win">âœ“</button>
                            <button class="icon-btn icon-loss" title="Loss">âœ•</button>
                         </div>`;
    } else if (h.status === 'Win') {
        resultContent = `<span class="result-icon win">âœ“</span>`;
    } else if (h.status === 'Lost') {
        resultContent = `<span class="result-icon loss">âœ•</span>`;
    }

    line.innerHTML = `<div class="history-period">${h.period}</div>
                      <div class="history-chips-row"></div>
                      <div class="history-right">${resultContent}</div>`;
    const chips = line.querySelector('.history-chips-row');
    for (let n=0;n<=9;n++){
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.textContent = n;
      if (n === h.number) chip.classList.add('highlighted');
      chips.appendChild(chip);
    }
    if (h.status==='Pending'){
      line.querySelector('.icon-win').onclick = () => markSpecific(idx,'Win');
      line.querySelector('.icon-loss').onclick = () => markSpecific(idx,'Lost');
    }
    historyLinesContainer.appendChild(line);
  }
}
function renderGameTable(){
  const confirmed = state.history.filter(h => h.status==='Win' || h.status==='Lost');
  gameTableBody.innerHTML = confirmed.map(h => `<tr>
    <td>${h.period}</td>
    <td>${numberToHTML(h.number)}</td>
    <td>${sizeBadgeHTML(h.size)}</td>
    <td>${colorDotHTML(h.color)}</td>
    <td class="${h.status==='Win'?'status-win':'status-lost'}">${h.status}</td>
  </tr>`).join('');
}
function renderStatsGrid(){
  const { freq, missing, avgMissing, maxConsec } = computeNumberStats(STATS_RANGE);

  // Winning Numbers row with red-bordered circular cells
  winningChips.innerHTML = Array(10).fill().map((_,n) => `<div class="cell">${n}</div>`).join('');
  
  // Other rows with plain numbers in circular cells
  missingRow.innerHTML = Array(10).fill().map((_, n) => `<div class="cell">${missing[n]}</div>`).join('');
  avgMissingRow.innerHTML = Array(10).fill().map((_, n) => `<div class="cell">${avgMissing[n]}</div>`).join('');
  frequencyRow.innerHTML = Array(10).fill().map((_, n) => `<div class="cell">${freq[n]}</div>`).join('');
  maxConsRow.innerHTML = Array(10).fill().map((_, n) => `<div class="cell">${maxConsec[n]}</div>`).join('');
}
function renderChartHistoryLines(){
  chartHistoryLinesContainer.innerHTML = '';
  const show = Math.min(state.history.length, 10); // Show last 10 periods for chart
  
  for (let idx=0; idx<show; idx++){
    const h = state.history[idx];
    const line = document.createElement('div');
    line.className = 'chart-history-line';
    line.innerHTML = `<div class="chart-period-label">${h.period}</div>
                      <div class="chart-chips-row"></div>
                      ${sizeBadgeHTML(h.size)}`; // Only size badge, no status text
    const chips = line.querySelector('.chart-chips-row');
    for (let n=0;n<=9;n++){
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.textContent = n;
      if (n === h.number) {
        chip.classList.add('highlighted');
      }
      chips.appendChild(chip);
    }
    chartHistoryLinesContainer.appendChild(line);
  }
  drawZigzagLines();
}

function drawZigzagLines(){
  let canvas = document.getElementById('zigzagCanvas');
  if (canvas) canvas.remove();

  canvas = document.createElement('canvas');
  canvas.id = 'zigzagCanvas';
  canvas.className = 'chart-line-canvas';
  chartHistoryLinesContainer.appendChild(canvas);

  const ctx = canvas.getContext('2d');
  
  canvas.width = chartHistoryLinesContainer.scrollWidth;
  canvas.height = chartHistoryLinesContainer.scrollHeight;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = 'var(--loss)';
  ctx.lineWidth = 2;
  ctx.shadowBlur = 0;
  ctx.lineJoin = 'round';

  ctx.beginPath();
  const lines = Array.from(chartHistoryLinesContainer.querySelectorAll('.chart-history-line'));
  let firstPoint = true;

  lines.forEach((line) => {
    const highlightedChip = line.querySelector('.chip.highlighted');
    if (highlightedChip) {
      const chipRect = highlightedChip.getBoundingClientRect();
      const containerRect = chartHistoryLinesContainer.getBoundingClientRect();

      const x = chipRect.left + chipRect.width / 2 - containerRect.left + chartHistoryLinesContainer.scrollLeft;
      const y = chipRect.top + chipRect.height / 2 - containerRect.top + chartHistoryLinesContainer.scrollTop;

      if (firstPoint) {
        ctx.moveTo(x, y);
        firstPoint = false;
      } else {
        ctx.lineTo(x, y);
      }
    }
  });
  ctx.stroke();
}
function markLatestAs(newStatus){
  if (!state.history.length) return;
  state.history[0].status = newStatus==='Win'?'Win':'Lost';
  saveState();
  
  // Calculate the next period number based on the last period
  const lastPeriod = state.history[0].period;
  const nextPeriod = incrementPeriodString(lastPeriod);
  
  // Update the period input and make a new prediction
  periodInput.value = nextPeriod;
  makePrediction(nextPeriod); // Call makePrediction with the new period. makePrediction will call renderAll again.
}
function markSpecific(idx, newStatus){
  if (!state.history[idx]) return;
  state.history[idx].status = newStatus==='Win'?'Win':'Lost';
  saveState();
  
  // If marking the latest prediction, auto-generate next
  if (idx === 0) {
      const lastPeriod = state.history[0].period;
      const nextPeriod = incrementPeriodString(lastPeriod);
      periodInput.value = nextPeriod;
      makePrediction(nextPeriod); // Call makePrediction with the new period.
  } else {
      renderAll(); // Only re-render all if not auto-generating next prediction
  }
}
function updateStats(){
  const confirmed = state.history.filter(h => h.status==='Win' || h.status==='Lost');
  const wins = confirmed.filter(h => h.status==='Win').length;
  const losses = confirmed.filter(h => h.status==='Lost').length;
  const total = wins + losses;
  statWin.textContent = wins;
  statLoss.textContent = losses;
  statAcc.textContent = total ? Math.round(wins / total * 100) + '%' : '0%';
  statRev.textContent = total ? Math.round(losses / total * 100) + '%' : '0%';
}
function updateStatsDisplay() {
  if (state.history.length > 0 && (state.history[0].status === 'Win' || state.history[0].status === 'Lost')) {
    statsRow.style.display = 'flex';
  } else {
    statsRow.style.display = 'none';
  }
}
function exportToCSV(){
  if (!state.history.length) return alert('No history');
  const rows = [['period','number','size','color','mode','status','notes','ts']];
  state.history.reverse().forEach(r => rows.push([r.period, r.number, r.size, r.color, r.mode, r.status, r.notes.replace(/\n/g, ' '), new Date(r.ts).toISOString()]));
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `cybertech_history_${Date.now()}.csv`; a.click();
  URL.revokeObjectURL(url);
}
function clearAllData(){
  if (!confirm('Clear all history?')) return;
  state.history = [];
  saveState();
  renderAll();
}
function animateNewResult(){
  displayNumber.classList.add('glow-anim');
  displaySize.classList.add('glow-anim');
  displayColor.classList.add('glow-anim');
  setTimeout(() => { [displayNumber, displaySize, displayColor].forEach(el => el.classList.remove('glow-anim')); }, 1000);
}
function switchTab(event) {
  event.preventDefault();
  const tabId = event.target.dataset.tab;
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.side-content').forEach(content => content.classList.remove('active'));
  document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
  document.getElementById(tabId).classList.add('active');
  if (tabId === 'chart') {
      setTimeout(drawZigzagLines, 100);
  }
}
function switchSubTab(event) {
  event.preventDefault();
  const subTabId = event.target.dataset.subTab;
  document.querySelectorAll('[data-sub-tab]').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.sub-content').forEach(content => content.classList.remove('active'));
  document.querySelector(`[data-sub-tab="${subTabId}"]`).classList.add('active');
  document.getElementById(subTabId).classList.add('active');
  if (subTabId === 'statistic') drawZigzagLines();
}
/* events */
document.querySelector('.panel').addEventListener('click', (e) => {
  if (e.target === predictBtn) {
    const p = periodInput.value.trim();
    if (!p) return alert('Enter period');
    makePrediction(p);
  } else if (e.target === markWin) {
    markLatestAs('Win');
  } else if (e.target === markLoss) {
    markLatestAs('Lost');
  } else if (e.target === clearAll) {
    clearAllData();
  } else if (e.target === exportCSV) {
    exportToCSV();
  } else if (e.target === btnSN) {
    state.mode = 'size-number';
    btnSN.classList.add('active');
    btnSC.classList.remove('active');
  } else if (e.target === btnSC) {
    state.mode = 'size-color';
    btnSC.classList.add('active');
    btnSN.classList.remove('active');
  }
});
document.querySelector('.side-tabs').addEventListener('click', (e) => {
  if (e.target.classList.contains('tab-btn')) switchTab(e);
});
document.querySelector('#chart').addEventListener('click', (e) => {
  if (e.target.classList.contains('tab-btn') && e.target.dataset.subTab) switchSubTab(e);
});
window.markSpecific = markSpecific;

// Resize observer to redraw canvas when container size changes
const resizeObserver = new ResizeObserver(entries => {
    for (let entry of entries) {
        if (entry.target === chartHistoryLinesContainer) {
            drawZigzagLines();
        }
    }
});


/* init */
(function init(){
  loadState();
  renderAll();
  // Ensure periodInput gets the correct next period number on initial load
  if (state.history.length > 0 && /^\d+$/.test(state.history[0].period)) { // Check if it's a valid number string
      periodInput.value = incrementPeriodString(state.history[0].period);
  } else {
      periodInput.value = ''; // Clear if no history or invalid period
  }

  resizeObserver.observe(chartHistoryLinesContainer);
})();
</script>
</body>
</html>