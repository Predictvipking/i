<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictor v11.0 - Gemini AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body, html {
            font-family: 'Exo 2', sans-serif;
            background: #0F0C29;
            color: #E0E7FF;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }

        ::-webkit-scrollbar { display: none; }
        html, body, #main-content {
            scrollbar-width: none;
            -ms-overflow-style: none;
            overflow: auto;
        }
        .table-container {
             overflow: auto;
        }

        .hidden { display: none !important; }

        .highlight-fuchsia { color: #FF00FF; }
        .bg-fuchsia-active { background: #FF00FF; }
        .text-fuchsia-active { color: #FF00FF; }
        .shadow-fuchsia-glow { box-shadow: 0 0 15px rgba(255, 0, 255, 0.7); }
        .border-fuchsia-glow { border-color: #FF00FF; }

        .status-win { background: rgba(0, 255, 127, 0.3); color: #00FF7F; }
        .status-loss { background: rgba(255, 85, 85, 0.3); color: #FF5555; }
        .status-partial { background: rgba(255, 170, 0, 0.3); color: #FFAA00; }

        .color-red { color: #FF5555; }
        .color-green { color: #00FF7F; }
        .color-violet { color: #D81BFF; }
        .color-big { color: #FFAA00; }
        .color-small { color: #00D4FF; }

        #login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #0F0C29, #302B63, #24243E);
        }
        .login-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        .login-card h1 { font-size: 2rem; font-weight: 700; }
        .login-card p { font-size: 0.9rem; color: #A5B4FC; margin-bottom: 1.5rem; }
        .login-card input {
            width: 100%; padding: 0.75rem; background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px;
            color: #E0E7FF; margin-bottom: 1rem; font-size: 1rem;
        }
        .login-card button {
            width: 100%; padding: 0.75rem; background: #FF00FF; color: #0F0C29;
            font-weight: 700; border: none; border-radius: 8px; cursor: pointer;
            transition: all 0.3s ease;
        }
        .login-card button:hover { box-shadow: 0 0 20px rgba(255, 0, 255, 0.6); }
        .error-message { color: #FF5555; font-size: 0.8rem; margin-top: 0.5rem; display: none; }

        #app-container {
            display: flex; justify-content: center; height: 100vh;
            background: linear-gradient(45deg, #0F0C29, #302B63, #24243E);
            padding: 0.5rem; box-sizing: border-box;
        }

        #main-content {
            width: 100%; max-width: 400px; padding: 0;
            position: relative; height: 100%;
        }

        .app-title-container {
            text-align: center; margin-top: 0.25rem; margin-bottom: 0.5rem;
        }
        .app-title-container h1 { font-size: 2rem; font-weight: 700; color: #E0E7FF; line-height: 1; }
        .app-title-container p { font-size: 0.65rem; color: #A5B4FC; margin-top: 0.1rem; }

        #game-mode-selector {
            background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px; padding: 0.3rem; backdrop-filter: blur(10px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3); overflow: hidden;
            width: 100%; margin-bottom: 0.5rem;
        }
        #game-mode-tabs {
            display: flex; justify-content: space-around; background: rgba(0, 0, 0, 0.2);
            border-radius: 12px; overflow-x: auto; margin-bottom: 0.1rem;
        }
        #game-mode-tabs button {
            flex: 1; padding: 0.4rem; font-size: 0.75rem; font-weight: 600;
            color: #A5B4FC; background: transparent; border: none; cursor: pointer;
            transition: all 0.3s ease; text-transform: uppercase;
        }
        #game-mode-tabs button.active {
            background: #FF00FF; color: #0F0C29;
            box-shadow: inset 0 0 8px rgba(255, 0, 255, 0.7);
            border-radius: 10px; margin: 0.05rem;
        }

        #interval-selector-container { padding: 0.05rem; text-align: center; }
        .mode-toggle {
            margin: 0 auto; border-radius: 9999px; background: rgba(0, 0, 0, 0.2);
            padding: 0.1rem;
        }
        .mode-toggle button {
            padding: 0.2rem 0.7rem; font-size: 0.65rem; font-weight: 500;
            border-radius: 9999px; transition: all 0.2s ease; color: #A5B4FC;
        }
        .mode-toggle button.active {
            background: #FF00FF; color: #0F0C29;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.6);
        }

        .main-card {
            background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px; padding: 0.5rem; margin-bottom: 0.5rem;
            backdrop-filter: blur(10px);
        }
        .info-grid { display: grid; grid-gap: 0.2rem; padding: 0.3rem; }
        .info-line {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.3rem 0.4rem; background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        .info-label { font-size: 0.85rem; color: #A5B4FC; display: flex; align-items: center; }
        .info-label svg { width: 1rem; height: 1rem; margin-right: 0.3rem; color: #FF00FF; }
        .info-value { font-size: 1rem; font-weight: 600; color: #E0E7FF; }
        #prediction-text .color-number { border: none; }

        .toggle-switch-container {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.3rem 0.4rem; background: rgba(0, 0, 0, 0.2);
            border-radius: 8px; margin: 0.5rem 0.3rem 0.3rem;
        }
        .toggle-switch-label { font-size: 0.85rem; font-weight: 600; color: #A5B4FC; }
        .toggle-switch {
            position: relative; display: inline-block; width: 44px; height: 24px;
            cursor: pointer;
        }
        .toggle-switch-handle {
            position: absolute; top: 2px; left: 2px; width: 20px; height: 20px;
            background-color: #E0E7FF; border-radius: 50%; transition: transform 0.3s ease;
        }
        .toggle-switch-bg {
            position: absolute; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.2); border-radius: 12px;
            transition: background-color 0.3s ease;
        }
        .toggle-switch.active .toggle-switch-bg { background-color: #FF00FF; }
        .toggle-switch.active .toggle-switch-handle { transform: translateX(20px); }

        .ai-sparkle-icon {
            width: 0.9rem; height: 0.9rem; color: #FFD700; margin-left: 0.3rem;
            animation: neonSparkle 1.2s infinite alternate;
        }
        @keyframes neonSparkle {
            0% { transform: scale(1); opacity: 0.8; filter: drop-shadow(0 0 2px #FFD700); }
            100% { transform: scale(1.3); opacity: 1; filter: drop-shadow(0 0 6px #FFD700); }
        }

        .chart-stats-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.3rem;
            margin-bottom: 0.5rem; padding: 0 0.3rem;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.08); padding: 0.3rem;
            border-radius: 8px; text-align: center;
        }
        .stat-label { font-size: 0.55rem; color: #A5B4FC; margin-bottom: 0.05rem; }
        .stat-value { font-size: 0.75rem; font-weight: 700; color: #E0E7FF; }
        .stat-value.win { color: #00FF7F; }
        .stat-value.loss { color: #FF5555; }
        .stat-value.partial { color: #FFAA00; }
        .stat-value.accuracy { color: #FF00FF; }
        .stat-value.revenue { color: #FFD700; }
        .stat-value.revenue.negative { color: #FF5555; }

        .table-container {
            max-height: 200px;
            border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px;
            position: relative;
        }
        table {
            width: 100%; border-collapse: collapse; font-size: 0.7rem;
            min-width: 350px; table-layout: fixed;
        }
        th, td {
            padding: 0.25rem 0.3rem; text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        th {
            background: rgba(25, 22, 50, 0.95); text-transform: uppercase;
            font-size: 0.6rem; color: #A5B4FC; position: sticky; top: 0;
            z-index: 10; box-shadow: inset 0 -1px 0 rgba(255, 255, 255, 0.1);
        }
        th:nth-child(1), td:nth-child(1) { width: 35%; }
        th:nth-child(2), td:nth-child(2) { width: 30%; }
        th:nth-child(3), td:nth-child(3) { width: 20%; }
        th:nth-child(4), td:nth-child(4) { width: 15%; }
        .status-pill {
            padding: 2px 6px; border-radius: 9999px; font-size: 0.6rem;
            font-weight: 600; display: inline-block; width: 100%; text-align: center;
        }

        .result-red { color: #FF5555; }
        .result-green { color: #00FF7F; }
        .result-violet { color: #D81BFF; }
        .result-big { color: #FFAA00; }
        .result-small { color: #00D4FF; }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .history-header h2 {
            font-size: 1rem;
            font-weight: 600;
        }
        .header-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #logout-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #logout-button:hover {
            background: rgba(255, 0, 255, 0.3);
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }
        #logout-button svg {
            width: 18px;
            height: 18px;
            color: #E0E7FF;
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h1 class="text-indigo-100">Predictor <span class="highlight-fuchsia">v11.0</span></h1>
            <p>Please enter your access key to continue</p>
            <input type="password" id="access-key-input" placeholder="••••••••" aria-label="Access Key">
            <p id="error-message" class="error-message" role="alert">Invalid Access Key!</p>
            <button id="login-button">Login</button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <main id="main-content">
            <div class="app-title-container">
                <h1 class="text-indigo-100">Predictor <span class="highlight-fuchsia">v11.0</span></h1>
                <p class="text-indigo-300">Gemini AI for Wingo & TRX</p>
            </div>

            <div id="game-mode-selector">
                <div id="game-mode-tabs">
                    <button id="tab-wingo" onclick="selectGameType('wingo')">Wingo</button>
                    <button id="tab-trx" onclick="selectGameType('trx')">TRX Wingo</button>
                </div>
                <div id="interval-selector-container">
                    <div id="wingo-intervals" class="mode-toggle hidden">
                        <button id="btn-wingo-30s" onclick="selectMode('wingo-30s')">30s</button>
                        <button id="btn-wingo-1m" onclick="selectMode('wingo-1m')">1m</button>
                    </div>
                    <div id="trx-intervals" class="mode-toggle hidden">
                        <button id="btn-trx-1m" onclick="selectMode('trx-1m')">1 Min</button>
                        <button id="btn-trx-3m" onclick="selectMode('trx-3m')">3 Min</button>
                    </div>
                </div>
            </div>

            <div class="main-card">
                <div class="toggle-switch-container">
                    <span class="toggle-switch-label">Reverse Pattern</span>
                    <div id="reverse-pattern-switch" class="toggle-switch">
                        <div class="toggle-switch-bg"></div>
                        <div class="toggle-switch-handle"></div>
                    </div>
                </div>
                <div class="info-grid">
                    <div class="info-line"><span class="info-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg>Period</span><p id="period" class="info-value">...</p></div>
                    <div class="info-line"><span class="info-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Timer</span><p id="timer" class="info-value text-red-500 font-bold text-base">--:--</p></div>
                    <div class="info-line"><span class="info-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>Prediction <svg class="ai-sparkle-icon" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.760-.415-2.212.749-2.305l5.404-.433 2.082-5.007z" clip-rule="evenodd" /></svg></span><p id="prediction-text" class="info-value font-bold"></p></div>
                    <div class="info-line"><span class="info-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m-16.5 0H6M6 3v11.25A2.25 2.25 0 008.25 16.5h7.5M6 3h7.5M12 3v11.25m0 0A2.25 2.25 0 0114.25 16.5h2.25M12 3h7.5m0 0h-1.5m1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5" /></svg>Insight</span><p id="insight-text" class="info-value text-xs text-cyan-400"></p></div>
                </div>
                <div class="chart-stats-grid">
                    <div class="stat-item"><div class="stat-label">Wins</div><div id="chart-total-wins" class="stat-value win">0</div></div>
                    <div class="stat-item"><div class="stat-label">Losses</div><div id="chart-total-losses" class="stat-value loss">0</div></div>
                    <div class="stat-item"><div class="stat-label">Partial</div><div id="chart-total-partial" class="stat-value partial">0</div></div>
                    <div class="stat-item"><div class="stat-label">Accuracy</div><div id="chart-accuracy" class="stat-value accuracy">0%</div></div>
                    <div class="stat-item"><div class="stat-label">Revenue</div><div id="chart-revenue" class="stat-value revenue">0</div></div>
                </div>
                <div class="history-header">
                    <h2>Prediction History</h2>
                    <div class="header-buttons">
                        <button id="clear-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md text-xs">Clear</button>
                        <button id="logout-button" onclick="handleLogout()" aria-label="Logout">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path fill-rule="evenodd" d="M7.5 3.75A1.5 1.5 0 006 5.25v13.5a1.5 1.5 0 001.5 1.5h6a1.5 1.5 0 001.5-1.5V15a.75.75 0 011.5 0v3.75a3 3 0 01-3 3h-6a3 3 0 01-3-3V5.25a3 3 0 013-3h6a3 3 0 013 3V9a.75.75 0 01-1.5 0V5.25a1.5 1.5 0 00-1.5-1.5h-6zm10.72 4.72a.75.75 0 011.06 0l3 3a.75.75 0 010 1.06l-3 3a.75.75 0 11-1.06-1.06l1.72-1.72H9a.75.75 0 010-1.5h10.94l-1.72-1.72a.75.75 0 010-1.06z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="table-container"><table><thead><tr><th>Period</th><th>Prediction</th><th>Result</th><th>Status</th></tr></thead><tbody id="predictions-table"></tbody></table></div>
            </div>
        </main>
    </div>

<script>
    // --- Global Elements and State ---
    const elements = {
        loginScreen: document.getElementById('login-screen'),
        appContainer: document.getElementById('app-container'),
        accessKeyInput: document.getElementById('access-key-input'),
        loginButton: document.getElementById('login-button'),
        errorMessage: document.getElementById('error-message'),
        logoutButton: document.getElementById('logout-button'),
        gameModeSelector: document.getElementById('game-mode-selector'),
        tabWingo: document.getElementById('tab-wingo'),
        tabTrx: document.getElementById('tab-trx'),
        wingoIntervals: document.getElementById('wingo-intervals'),
        trxIntervals: document.getElementById('trx-intervals'),
        period: document.getElementById('period'),
        timer: document.getElementById('timer'),
        predictionText: document.getElementById('prediction-text'),
        insightText: document.getElementById('insight-text'),
        predictionsTable: document.getElementById('predictions-table'),
        clearButton: document.getElementById('clear-button'),
        chartTotalWins: document.getElementById('chart-total-wins'),
        chartTotalLosses: document.getElementById('chart-total-losses'),
        chartTotalPartial: document.getElementById('chart-total-partial'),
        chartAccuracy: document.getElementById('chart-accuracy'),
        chartRevenue: document.getElementById('chart-revenue'),
        btnWingo30s: document.getElementById('btn-wingo-30s'),
        btnWingo1m: document.getElementById('btn-wingo-1m'),
        btnTrx1m: document.getElementById('btn-trx-1m'),
        btnTrx3m: document.getElementById('btn-trx-3m'),
        reversePatternSwitch: document.getElementById('reverse-pattern-switch'),
    };
    const ACCESS_KEY = "Kingvip@1990$";
    let masterInterval;
    let currentMode = null;
    let currentGameType = 'wingo';

    const initialStateTemplate = {
        history: [],
        predictions: [],
        currentPeriod: null,
        isReversePattern: false,
        stats: { totalWins: 0, totalLosses: 0, totalPartial: 0, revenue: 0 },
        consecutiveLosses: 0,
    };
    let state = {
        'wingo-30s': JSON.parse(JSON.stringify(initialStateTemplate)),
        'wingo-1m': JSON.parse(JSON.stringify(initialStateTemplate)),
        'trx-1m': JSON.parse(JSON.stringify(initialStateTemplate)),
        'trx-3m': JSON.parse(JSON.stringify(initialStateTemplate))
    };

    // --- State Management ---
    let saveStateTimeout;
    function debounceSaveState() {
        clearTimeout(saveStateTimeout);
        saveStateTimeout = setTimeout(saveState, 500);
    }

    function saveState() {
        try {
            localStorage.setItem('predictorStateV11_0', JSON.stringify(state));
        } catch (e) { console.warn('localStorage unavailable:', e); }
    }

    function loadState() {
        try {
            const savedState = localStorage.getItem('predictorStateV11_0');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                for (const mode in state) {
                    if (parsedState[mode]) {
                        state[mode] = { ...JSON.parse(JSON.stringify(initialStateTemplate)), ...parsedState[mode] };
                    }
                }
            }
        } catch (e) {
            console.warn('Failed to load state:', e);
            localStorage.removeItem('predictorStateV11_0');
        }
    }

    // --- Auth & Navigation ---
    function handleLogin() {
        if (elements.accessKeyInput.value.trim() === ACCESS_KEY) {
            localStorage.setItem('isLoggedIn', 'true');
            elements.errorMessage.style.display = 'none';
            requestAnimationFrame(showApp);
        } else {
            elements.errorMessage.style.display = 'block';
            elements.accessKeyInput.focus();
        }
    }

    function handleLogout() {
        localStorage.removeItem('isLoggedIn');
        clearInterval(masterInterval);
        elements.appContainer.classList.add('hidden');
        elements.loginScreen.classList.remove('hidden');
        elements.accessKeyInput.value = '';
    }

    function showApp() {
        elements.loginScreen.classList.add('hidden');
        elements.appContainer.classList.remove('hidden');
        loadState();
        selectGameType('wingo');
    }

    function selectGameType(gameType) {
        clearInterval(masterInterval);
        currentMode = null;
        currentGameType = gameType;
        elements.tabWingo.classList.toggle('active', gameType === 'wingo');
        elements.tabTrx.classList.toggle('active', gameType === 'trx');
        elements.wingoIntervals.classList.toggle('hidden', gameType !== 'wingo');
        elements.trxIntervals.classList.toggle('hidden', gameType !== 'trx');
        masterClock.debounce = {};
        if (gameType === 'wingo') selectMode('wingo-30s');
        else selectMode('trx-1m');
    }

    function selectMode(mode) {
        if (currentMode === mode) return;
        clearInterval(masterInterval);
        currentMode = mode;
        [elements.btnWingo30s, elements.btnWingo1m, elements.btnTrx1m, elements.btnTrx3m].forEach(btn => {
            if (btn) btn.classList.remove('active');
        });
        const btn = document.getElementById(`btn-${mode}`);
        if (btn) btn.classList.add('active');
        render();
        gameLoop();
        masterInterval = setInterval(masterClock, 1000);
    }

    // --- UI Rendering ---
    function getResultFromNumber(num) {
        const result = { number: num, bigSmall: num >= 5 ? 'Big' : 'Small', color: '' };
        if (num === 0) result.color = 'Red+Violet';
        else if (num === 5) result.color = 'Green+Violet';
        else if ([1, 3, 7, 9].includes(num)) result.color = 'Green';
        else result.color = 'Red';
        return result;
    }

    function renderResultInHTML(result) {
        if (!result) return '...';
        const { number, bigSmall, color } = result;
        let colorText = `<span class="result-${color.toLowerCase()}">${color}</span>`;
        if (color === 'Red+Violet') colorText = `<span class="result-red">Red</span><span class="result-violet">+Violet</span>`;
        else if (color === 'Green+Violet') colorText = `<span class="result-green">Green</span><span class="result-violet">+Violet</span>`;
        return `<span class="color-number">${number}</span>, <span class="result-${bigSmall.toLowerCase()}">${bigSmall}</span>, ${colorText}`;
    }

    function render() {
        if (!currentMode) return;
        const activeState = state[currentMode];
        elements.period.textContent = activeState.currentPeriod || '...';
        elements.reversePatternSwitch.classList.toggle('active', activeState.isReversePattern);
        const latestPrediction = activeState.predictions[activeState.predictions.length - 1];
        elements.predictionText.innerHTML = latestPrediction ? renderResultInHTML(latestPrediction.prediction) : '...';
        elements.insightText.textContent = latestPrediction ? latestPrediction.strategy : 'Awaiting data...';
        elements.chartTotalWins.textContent = activeState.stats.totalWins;
        elements.chartTotalLosses.textContent = activeState.stats.totalLosses;
        elements.chartTotalPartial.textContent = activeState.stats.totalPartial;
        const totalGames = activeState.stats.totalWins + activeState.stats.totalLosses;
        elements.chartAccuracy.textContent = totalGames > 0 ? `${Math.round((activeState.stats.totalWins / totalGames) * 100)}%` : '0%';
        elements.chartRevenue.textContent = activeState.stats.revenue.toFixed(2);
        elements.chartRevenue.classList.toggle('negative', activeState.stats.revenue < 0);
        elements.predictionsTable.innerHTML = '';
        activeState.predictions.slice().reverse().slice(0, 20).forEach(pred => {
            const row = document.createElement('tr');
            const result = activeState.history.find(h => h.period === pred.period);
            row.innerHTML = `
                <td>${pred.period}</td>
                <td>${renderResultInHTML(pred.prediction)}</td>
                <td>${result ? renderResultInHTML(result) : 'Pending'}</td>
                <td><span class="status-pill status-${pred.status.toLowerCase()}">${pred.status}</span></td>
            `;
            elements.predictionsTable.appendChild(row);
        });
    }

    // --- Period Generation ---
    function generateWingoPeriodNumber(mode) { 
        const now = new Date(); 
        const dateStr = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
        const istOffsetMinutes = 330;
        const istTime = new Date(now.getTime() + (istOffsetMinutes * 60 * 1000) + (now.getTimezoneOffset() * 60 * 1000));
        const h = istTime.getHours(), m = istTime.getMinutes(), s = istTime.getSeconds();
        const startH = 5, startM = 30;
        let elapsedS = (h * 3600 + m * 60 + s) - (startH * 3600 + startM * 60);
        if (elapsedS < 0) elapsedS += 24 * 3600;
        const periodDuration = mode === 'wingo-1m' ? 60 : 30;
        const periodCounter = Math.floor(elapsedS / periodDuration) + 1;
        const suffix = mode === 'wingo-1m' ? `10001${String(periodCounter).padStart(4, '0')}` : `100005${String(periodCounter).padStart(4, '0')}`;
        return dateStr + suffix;
    }

    function generateTrxPeriodNumber(mode) {
        const now = new Date();
        const dateStr = now.getUTCFullYear() + String(now.getUTCMonth() + 1).padStart(2, '0') + String(now.getUTCDate()).padStart(2, '0');
        const totalMinutesTodayUTC = (now.getUTCHours() * 60) + now.getUTCMinutes();
        if (mode === 'trx-1m') {
            return `${dateStr}1030${String(totalMinutesTodayUTC + 10001).padStart(5, '0')}`;
        } else {
            return `${dateStr}1030${String(Math.floor(totalMinutesTodayUTC / 3) + 20001).padStart(5, '0')}`;
        }
    }

    // --- Gemini AI Prediction Engine ---
    async function getAIPrediction(history) {
        const schema = {
            type: "OBJECT",
            properties: {
                "color": { "type": "STRING", "enum": ["Red", "Green"] },
                "bigSmall": { "type": "STRING", "enum": ["Big", "Small"] }
            },
            required: ["color", "bigSmall"]
        };

        const historyForPrompt = history.slice(-10).map(h => ({ number: h.number, color: h.color.replace('+Violet', ''), size: h.bigSmall }));
        const prompt = `You are an expert Wingo game analyst. Based on the following recent game history (most recent is last), predict the color and size for the next round. Provide your prediction in JSON format. History: ${JSON.stringify(historyForPrompt)}`;
        
        try {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };
            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                console.error("API Error Response:", await response.text());
                return null;
            }

            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const jsonText = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonText);
            }
            return null;
        } catch (error) {
            console.error("Error fetching AI prediction:", error);
            return null;
        }
    }


    async function runPredictionEngine(history) {
        const activeState = state[currentMode];
        if (history.length < 5) {
            return { prediction: getResultFromNumber(Math.floor(Math.random() * 10)), strategy: 'Collecting data...' };
        }

        elements.insightText.textContent = 'AI is thinking...';
        const aiResult = await getAIPrediction(history);
        
        let predictedColor, predictedBigSmall, strategy;

        if (aiResult && aiResult.color && aiResult.bigSmall) {
            predictedColor = aiResult.color;
            predictedBigSmall = aiResult.bigSmall;
            strategy = "Gemini AI Analysis";
        } else {
            // Fallback to old logic if AI fails
            const lastResult = history[history.length - 1];
            predictedColor = lastResult.color.includes('Red') ? 'Green' : 'Red';
            predictedBigSmall = lastResult.bigSmall === 'Big' ? 'Small' : 'Big';
            strategy = "Fallback Logic";
        }
        
        // Reverse logic if toggled
        if (activeState.isReversePattern) {
            predictedColor = predictedColor === 'Red' ? 'Green' : 'Red';
            predictedBigSmall = predictedBigSmall === 'Big' ? 'Small' : 'Big';
            strategy += " (Reversed)";
        }

        // Find a matching number
        const possibleNumbers = [];
        for (let i = 0; i <= 9; i++) {
            const res = getResultFromNumber(i);
            if (res.bigSmall === predictedBigSmall && res.color.includes(predictedColor)) {
                possibleNumbers.push(i);
            }
        }
        
        const predictedNumber = possibleNumbers.length > 0 ? possibleNumbers[Math.floor(Math.random() * possibleNumbers.length)] : Math.floor(Math.random() * 10);
        return { prediction: getResultFromNumber(predictedNumber), strategy };
    }

    // --- Game Simulation & Stats ---
    function updateStats(actualResult) {
        if (!currentMode || !actualResult) return;
        const p = state[currentMode].predictions.find(pred => pred.period === actualResult.period);
        if (!p || p.status !== 'Pending') return;

        const predColor = p.prediction.color.replace('+Violet', '');
        const actualColor = actualResult.color.replace('+Violet', '');
        const colorMatch = predColor === actualColor;
        const sizeMatch = p.prediction.bigSmall === actualResult.bigSmall;
        let revenueChange = -1;

        if (p.prediction.number === actualResult.number) {
            p.status = 'Win';
            revenueChange = 8;
        } else if (colorMatch && sizeMatch) {
            p.status = 'Win';
            revenueChange = 1;
        } else if (colorMatch || sizeMatch) {
            p.status = 'Partial';
            revenueChange = -0.5;
        } else {
            p.status = 'Loss';
        }

        const activeState = state[currentMode];
        if (p.status === 'Win') {
            activeState.stats.totalWins++;
        } else if (p.status === 'Partial') {
            activeState.stats.totalPartial++;
        } else {
            activeState.stats.totalLosses++;
        }
        activeState.stats.revenue += revenueChange;
        debounceSaveState();
    }

    async function gameLoop() {
        if (!currentMode) return;
        const activeState = state[currentMode];

        if (activeState.currentPeriod) {
            const resultExists = activeState.history.some(h => h.period === activeState.currentPeriod);
            if (!resultExists) {
                const simulatedResult = getResultFromNumber(Math.floor(Math.random() * 10));
                simulatedResult.period = activeState.currentPeriod;
                updateStats(simulatedResult);
                activeState.history.push(simulatedResult);
                if (activeState.history.length > 100) activeState.history.shift();
            }
        }

        const newPeriod = (currentGameType === 'wingo') ? generateWingoPeriodNumber(currentMode) : generateTrxPeriodNumber(currentMode);
        const predictionExists = activeState.predictions.some(p => p.period === newPeriod);
        if (predictionExists) {
            render();
            return;
        }

        activeState.currentPeriod = newPeriod;
        
        // This is now async
        const { prediction, strategy } = await runPredictionEngine(activeState.history);
        
        activeState.predictions.push({ period: newPeriod, prediction, strategy, status: 'Pending' });
        if (activeState.predictions.length > 100) activeState.predictions.shift();

        debounceSaveState();
        render();
    }

    function masterClock() {
        if (!currentMode) return;
        const duration = { 'wingo-30s': 30, 'wingo-1m': 60, 'trx-1m': 60, 'trx-3m': 180 }[currentMode];
        const now = new Date();
        let remainingTime, secondsSinceEpoch;

        if (currentGameType === 'wingo') {
            const istOffsetMs = 330 * 60 * 1000;
            const istTime = new Date(now.getTime() + istOffsetMs + (now.getTimezoneOffset() * 60 * 1000));
            const startOfDay = new Date(istTime);
            startOfDay.setHours(5, 30, 0, 0);
            secondsSinceEpoch = Math.floor((istTime - startOfDay) / 1000);
            if (secondsSinceEpoch < 0) secondsSinceEpoch += 86400;
        } else {
            secondsSinceEpoch = now.getUTCHours() * 3600 + now.getUTCMinutes() * 60 + now.getUTCSeconds();
        }
        
        remainingTime = duration - (secondsSinceEpoch % duration);
        elements.timer.textContent = `${String(Math.floor(remainingTime / 60)).padStart(2, '0')}:${String(remainingTime % 60).padStart(2, '0')}`;
        
        if (remainingTime === duration || remainingTime === 1) {
             const debounceKey = currentMode + 'Trigger';
             const nowMs = now.getTime();
             if (!masterClock.debounce[debounceKey] || (nowMs - masterClock.debounce[debounceKey] > 1500)) {
                 gameLoop(); // Call async function
                 masterClock.debounce[debounceKey] = nowMs;
             }
        }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        if (!elements.loginButton) return;
        elements.loginButton.addEventListener('click', handleLogin);
        elements.accessKeyInput.addEventListener('keyup', e => e.key === 'Enter' && handleLogin());
        elements.logoutButton.addEventListener('click', handleLogout);
        elements.clearButton.addEventListener('click', () => {
            if (currentMode) {
                state[currentMode] = JSON.parse(JSON.stringify(initialStateTemplate));
                debounceSaveState();
                render();
            }
        });
        elements.reversePatternSwitch.addEventListener('click', () => {
            if (currentMode) {
                state[currentMode].isReversePattern = !state[currentMode].isReversePattern;
                gameLoop(); // Call async function
            }
        });
        if (localStorage.getItem('isLoggedIn') === 'true') {
            requestAnimationFrame(showApp);
        }
    });
</script>
</body>
</html>
